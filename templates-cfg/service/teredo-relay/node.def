priority: 930
help: teredo relay settings
end:
	if [ ${COMMIT_ACTION} == 'SET' -o ${COMMIT_ACTION} = 'ACTIVE' ]; then
		echo 'Re-generating miredo config file'

		(echo '#Generated by Vyatta, do not edit!'
		 echo 'RelayType cone'
		 echo "BindAddress $VAR(public-address/@)"
		 echo "BindPort $VAR(port/@)"
		 echo "InterfaceName teredo-relay"
		) > /tmp/miredo.conf
		if ! /usr/sbin/miredo-checkconf /tmp/miredo.conf; then
			echo 'Generated miredo configuration failed check'
			exit 1
		fi

		sudo /etc/init.d/miredo stop

		sudo mv /tmp/miredo.conf /etc/miredo.conf
		sudo mkdir -p /var/run/miredo
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'START_MIREDO=true'
		 echo 'DAEMON_ARGS="-c /etc/miredo.conf -t /var/run/miredo"'
		) > /tmp/miredo.default
		sudo mv /tmp/miredo.default /etc/default/miredo
                
		sudo /etc/init.d/miredo start
	else
		sudo /etc/init.d/miredo stop
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'START_MIREDO=false'
		 echo 'DAEMON_ARGS=""'
		) > /tmp/miredo.default
		sudo mv /tmp/miredo.default /etc/default/miredo
	fi
