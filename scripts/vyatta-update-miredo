#!/bin/bash

# Fail on error
set -e

# Paths
MIREDO_ROOT=/var/run/miredo
MIREDO_CFG_TMP=/tmp/miredo.conf.vyatta-generated
MIREDO_CFG=/etc/miredo.conf.vyatta-generated
MIREDO_DEFAULT_TMP=/tmp/miredo.default
MIREDO_DEFAULT=/etc/default/miredo

# Arguments
function usage() {
	echo "$0 disable | { enable <iface> <addr> <port> }" >&2
	exit 1
}

cfg_action=$1; shift || usage

case "$cfg_action" in
	enable)
		# Arguments
		cfg_iface=$1; shift || usage
		cfg_addr=$1; shift || usage
		cfg_port=$1; shift || usage

		# Generate config & enable
		echo 'Enabling miredo and re-generating config file'
		mkdir -p $MIREDO_ROOT
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'RelayType cone'
		 echo "InterfaceName $cfg_iface"
		 echo "BindAddress $cfg_addr"
		 echo "BindPort $cfg_port"
		) > $MIREDO_CFG_TMP 
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'START_MIREDO=true'
		 echo "DAEMON_ARGS='-c $MIREDO_CFG -t $MIREDO_ROOT'"
		) > $MIREDO_DEFAULT_TMP
		if ! /usr/sbin/miredo-checkconf $MIREDO_CFG_TMP; then
			echo "Config file contains:"
			cat $MIREDO_CFG_TMP
			exit 1
		fi
		
		# (Re)start
		/etc/init.d/miredo stop
		mv $MIREDO_CFG_TMP $MIREDO_CFG
		mv $MIREDO_DEFAULT_TMP $MIREDO_DEFAULT
		/etc/init.d/miredo start 
		;;
	disable)
		echo 'Disabling miredo'

		# Disable & stop
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'START_MIREDO=false'
		 echo 'DAEMON_ARGS=""'
		) > $MIREDO_DEFAULT
		rm $MIREDO_CFG 2>/dev/null || true
		/etc/init.d/miredo stop
		;;
	*)
		usage
		;;
esac
